<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedidos Moto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
  <main class="w-full max-w-md">
    <h1 class="text-2xl font-semibold mb-4 text-center text-gray-800">Pedidos de Moto</h1>
    <div id="cards-container" class="space-y-3"></div>
  </main>

  <script>
    // Simulando o conte√∫do do pedidos.json localmente para teste
    // Em produ√ß√£o, substituir fetchPedidos para buscar do servidor/GitHub
    let pedidosData = {
      "pedidos": [
        {
          "id": "202508260005",
          "tipo": "Moto Entrega",
          "origem": "Rua Alegrete 678",
          "destino": "Aero rancho",
          "rota": "https://www.google.com/maps/dir/?api=1&origin=Rua%20Alegrete%20678&destination=Aero%20rancho&travelmode=motorcycle",
          "passageiro": "Matheus Neves",
          "telefone": "67992321321",
          "status": "Buscando Entregador"
        },
        {
          "id": "202508260015",
          "tipo": "Moto Passageiro",
          "origem": "Rua Alegrete 678",
          "destino": "Rua Amazonas 670",
          "rota": "https://www.google.com/maps/dir/?api=1&origin=Rua%20Alegrete%20678&destination=Rua%20Amazonas%20670&travelmode=motorcycle",
          "passageiro": "Matheus Neves",
          "telefone": "67992321321",
          "status": "Buscando Motorista"
        },
        {
          "id": "202508260018",
          "tipo": "Moto Entrega",
          "origem": "Rua Alegrete 678",
          "destino": "Rua Bahia 78",
          "rota": "https://www.google.com/maps/dir/?api=1&origin=Rua%20Alegrete%20678&destination=Rua%20Bahia%2078&travelmode=motorcycle",
          "passageiro": "Jorgehhhh",
          "telefone": "67992321321",
          "status": "Buscando Entregador"
        }
      ]
    };

    const cardsContainer = document.getElementById('cards-container');

    function formatPhone(phone) {
      if (!phone) return '';
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 11) return `(${cleaned.slice(0, 2)}) ${cleaned.slice(2, 7)}-${cleaned.slice(7)}`;
      if (cleaned.length === 10) return `(${cleaned.slice(0, 2)}) ${cleaned.slice(2, 6)}-${cleaned.slice(6)}`;
      return phone;
    }

    // Identificador √∫nico do usu√°rio (simulado)
    // Em produ√ß√£o, usar autentica√ß√£o real para identificar usu√°rio
    const currentUserId = localStorage.getItem('userId') || generateUserId();
    localStorage.setItem('userId', currentUserId);

    function generateUserId() {
      return 'user-' + Math.random().toString(36).substr(2, 9);
    }

    // Guardar localmente os pedidos aceitos pelo usu√°rio: { pedidoId: userId }
    // Para simular multiusu√°rio, armazenamos no localStorage um objeto JSON
    // que mapeia pedidoId para userId que aceitou
    const acceptedKey = 'pedidosAceitosPorUsuario';

    function getAcceptedPedidos() {
      const data = localStorage.getItem(acceptedKey);
      return data ? JSON.parse(data) : {};
    }

    function setAcceptedPedido(pedidoId, userId) {
      const accepted = getAcceptedPedidos();
      accepted[pedidoId] = userId;
      localStorage.setItem(acceptedKey, JSON.stringify(accepted));
    }

    function removeAcceptedPedido(pedidoId) {
      const accepted = getAcceptedPedidos();
      if (accepted[pedidoId]) {
        delete accepted[pedidoId];
        localStorage.setItem(acceptedKey, JSON.stringify(accepted));
      }
    }

    // Atualiza status localmente e controla visibilidade conforme usu√°rio
    function updatePedidoStatus(pedidoId, novoStatus) {
      const pedidoIndex = pedidosData.pedidos.findIndex(p => p.id === pedidoId);
      if (pedidoIndex === -1) {
        alert("Pedido n√£o encontrado");
        return;
      }

      // Se aceitou, registra o usu√°rio que aceitou
      if (novoStatus.toLowerCase() === 'aceito') {
        setAcceptedPedido(pedidoId, currentUserId);
      } else if (novoStatus.toLowerCase() === 'buscando entregador' || novoStatus.toLowerCase() === 'buscando motorista') {
        // Se voltou para buscando, remove aceita√ß√£o
        removeAcceptedPedido(pedidoId);
      }

      pedidosData.pedidos[pedidoIndex].status = novoStatus;
      alert(`‚úÖ Pedido ${pedidoId} atualizado para ${novoStatus}`);
      renderPedidos(pedidosData.pedidos);
    }

    function createCard(pedido) {
      const acceptedPedidos = getAcceptedPedidos();
      const acceptedByUser = acceptedPedidos[pedido.id] === currentUserId;
      const acceptedByOther = acceptedPedidos[pedido.id] && acceptedPedidos[pedido.id] !== currentUserId;

      // Se pedido est√° aceito por outro usu√°rio, n√£o mostrar o card
      if (acceptedByOther) return null;

      const card = document.createElement('article');
      card.className = 'bg-white rounded-lg shadow p-4 flex flex-col space-y-2 text-sm';

      let statusColor = 'text-gray-500';
      const statusLower = pedido.status.toLowerCase();
      if (statusLower === 'buscando entregador' || statusLower === 'buscando motorista') statusColor = 'text-red-600 font-semibold';
      else if (statusLower === 'disponivel') statusColor = 'text-green-600 font-semibold';
      else if (statusLower === 'em andamento') statusColor = 'text-yellow-600 font-semibold';
      else if (statusLower === 'finalizado') statusColor = 'text-gray-400 font-semibold line-through';
      else if (statusLower === 'aceito') statusColor = 'text-green-700 font-semibold';

      let actionButton = '';
      if (statusLower === 'buscando entregador' || statusLower === 'buscando motorista') {
        actionButton = `<button onclick="updatePedidoStatus('${pedido.id}', 'Aceito')" class="mt-2 px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-md text-xs w-full">‚úÖ Aceitar</button>`;
      } else if (statusLower === 'aceito' && acceptedByUser) {
        actionButton = `<button onclick="updatePedidoStatus('${pedido.id}', 'Em andamento')" class="mt-2 px-3 py-1.5 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md text-xs w-full">üèÅ Iniciar</button>`;
      } else if (statusLower === 'em andamento' && acceptedByUser) {
        actionButton = `<button onclick="updatePedidoStatus('${pedido.id}', 'Finalizado')" class="mt-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-xs w-full">‚úîÔ∏è Finalizar</button>`;
      }

      // Se status √© "Aceito" but user is not the accepter, card is hidden above (return null)
      // If status is "Aceito" and user is accepter, show card with buttons

      card.innerHTML = `
        <header class="flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-800">${pedido.tipo}</h2>
          <span class="${statusColor} capitalize">${pedido.status}</span>
        </header>
        <div class="space-y-1">
          <p><i class="fas fa-map-marker-alt text-red-500 mr-1"></i><strong>Origem:</strong> ${pedido.origem}</p>
          <p><i class="fas fa-map-marker-alt text-green-500 mr-1"></i><strong>Destino:</strong> ${pedido.destino}</p>
          <p><i class="fas fa-user text-blue-500 mr-1"></i><strong>Passageiro:</strong> ${pedido.passageiro}</p>
          <p><i class="fas fa-phone-alt text-indigo-500 mr-1"></i><strong>Telefone:</strong> 
            <a href="tel:${pedido.telefone}" class="text-indigo-600 hover:underline">${formatPhone(pedido.telefone)}</a>
          </p>
        </div>
        <a href="${pedido.rota}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center mt-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors duration-200 text-xs w-full">
          <i class="fas fa-route mr-1"></i> Ver Rota no Google Maps
        </a>
        ${actionButton}
      `;
      return card;
    }

    function renderPedidos(pedidos) {
      cardsContainer.innerHTML = '';
      if (!pedidos || pedidos.length === 0) {
        cardsContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum pedido dispon√≠vel no momento.</p>';
        return;
      }
      let anyVisible = false;
      pedidos.forEach(pedido => {
        const card = createCard(pedido);
        if (card) {
          cardsContainer.appendChild(card);
          anyVisible = true;
        }
      });
      if (!anyVisible) {
        cardsContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum pedido dispon√≠vel no momento.</p>';
      }
    }

    function fetchPedidos() {
      // Como estamos usando dados locais, s√≥ renderiza
      renderPedidos(pedidosData.pedidos);
    }

    fetchPedidos();
  </script>
</body>
</html>
